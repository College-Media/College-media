{% extends "user_pages/base.html" %}
{% block style %}
#profile-image-placeholder {
    width: 30px;
    height: 30px;
    background-color: #ccc;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    border-radius: 50%;
    border:1px solid black;
    font-weight: bold;
    cursor:pointer;
}
.like-icon {
    cursor: pointer;
    transition: fill 0.3s ease;
}
.liked {
    fill: red;
}
.unliked {
    fill: black;
}
{% endblock style %}

{% block content %}
<div class="right">
    <!-- Start of Posts -->
    {% for post in posts %}
    {% if post.is_approved %}
    <div class="post" id="post-{{ post.id }}">
        <div class="post-head">
        {% if user.roll_number == post.student.roll_number %}
        
            <div class="post-profile" onclick="window.location='/user_dash/user_profile'">
                 {% else %}
                 <div class="post-profile" onclick="window.location='/student_details/{{post.student.id}}'">
            {% endif %}
            
                {% if post.student.profile_image %}
                <img src="{{ post.student.profile_image.url }}" class="post-profile-img" alt="Profile Picture">
                <div class="post-profile-name">{{post.student.name}}:{{post.student}}</div>
                {% else %}
                <div id="profile-image-placeholder">
                    {{ post.student.name|slice:":2"|upper }}
                </div>
                <div class="post-profile-name">{{post.student.name}}:{{post.student}}</div>
                {% endif %}
            </div>
            <div class="post-menu">
                <div class="post-menu-icon" >
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                        fill="#5f6368">
                        <path
                            d="M240-400q-33 0-56.5-23.5T160-480q0-33 23.5-56.5T240-560q33 0 56.5 23.5T320-480q0 33-23.5 56.5T240-400Zm240 0q-33 0-56.5-23.5T400-480q0-33 23.5-56.5T480-560q33 0 56.5 23.5T560-480q0 33-23.5 56.5T480-400Zm240 0q-33 0-56.5-23.5T640-480q0-33 23.5-56.5T720-560q33 0 56.5 23.5T800-480q0 33-23.5 56.5T720-400Z" />
                    </svg>
                    <div id="post-menu-table">
                        <ul>
                            <li><a href="#" style="text-decoration: none;color:red">Report</a></li>
                            <li  class="cancelBtnHome">Cancel</li>
                        </ul>
                    </div>
                </div>

            </div>
        </div>

        <div class="post-body"><img src="{{post.image.url}}" alt="Post Image"></div>
       
        <div class="post-foot">
            <div class="post-like">                
    <svg
    class="like-icon {% if post.id in liked_post_ids %}liked{% else %}unliked{% endif %}" 
        xmlns="http://www.w3.org/2000/svg" 
        viewBox="0 0 512 512" 
        width="24px" 
        height="24px" 
        onclick="likePost({{ post.id }})" 
        id="like-icon-{{ post.id }}">
        <path d="M47.6 300.4L228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6 0 115.2 0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z" />
    </svg>                
    <span id="like-count-{{ post.id }}">{{ post.likes.count }}</span> Likes
    
    
</div>

            <div class="comment" onclick="showcomment()">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px"  viewBox="0 -960 960 960" width="24px" fill="#FFFFFF"><path d="M80-80v-720q0-33 23.5-56.5T160-880h640q33 0 56.5 23.5T880-800v480q0 33-23.5 56.5T800-240H240L80-80Zm126-240h594v-480H160v525l46-45Zm-46 0v-480 480Z"/></svg>
            </div>
            {% comment %} <div class="comment-section">
                <div id="comments-container-{{ post.id }}">
                    <!-- Display existing comments here using AJAX -->
                </div>
    
                <!-- Comment submission form -->
                <textarea id="commentContent-{{ post.id }}" placeholder="Write a comment..."></textarea>
                <button onclick="submitComment({{ post.id }})">Post Comment</button>
            </div>   {% endcomment %}
        </div>
    </div>
    {% endif %}
    {% endfor %}
</div>

<script>
    history.scrollRestoration = "manual"; // Prevents automatic scroll restoration
    window.onload = function() {
        window.scrollTo(0, 0); // Ensures scroll starts at the top
    }; 

    document.addEventListener("DOMContentLoaded", function() {
        window.likePost = function(postId) {
            const likeIconElement = document.getElementById(`like-icon-${postId}`);
            const likeCountElement = document.getElementById(`like-count-${postId}`);
            
            // Check if the element exists
            if (!likeIconElement || !likeCountElement) {
                console.error(`Elements for post ${postId} not found.`);
                return;
            }
            
            // Optimistic UI toggle
            let isLiked = likeIconElement.classList.contains('liked');
            console.log(`Initial state: ${isLiked ? 'liked' : 'unliked'}`);
            
            if (isLiked) {
                likeIconElement.classList.remove('liked');
                likeIconElement.classList.add('unliked');
                likeCountElement.innerText = parseInt(likeCountElement.innerText) - 1;
            } else {
                likeIconElement.classList.remove('unliked');
                likeIconElement.classList.add('liked');
                likeCountElement.innerText = parseInt(likeCountElement.innerText) + 1;
            }
    
            // Send like/unlike request to the server
            fetch(`/like/${postId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
            })
            .then(response => response.json())
            .then(data => {
                // Update the UI based on the server's response
                console.log('Server response:', data);
                likeCountElement.innerText = data.like_count;
                if (data.liked) {
                    likeIconElement.classList.add('liked');
                    likeIconElement.classList.remove('unliked');
                } else {
                    likeIconElement.classList.add('unliked');
                    likeIconElement.classList.remove('liked');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Revert UI if the request fails
                if (isLiked) {
                    likeIconElement.classList.add('liked');
                    likeIconElement.classList.remove('unliked');
                    likeCountElement.innerText = parseInt(likeCountElement.innerText) + 1;
                } else {
                    likeIconElement.classList.add('unliked');
                    likeIconElement.classList.remove('liked');
                    likeCountElement.innerText = parseInt(likeCountElement.innerText) - 1;
                }
            });
        };
    });
    

        // Function to periodically update like counts for all posts
        function updateLikeCounts() {
            fetch('/like-counts/')
                .then(response => response.json())
                .then(data => {
                    // Update like counts based on the response
                    for (const [postId, likeCount] of Object.entries(data)) {
                        const likeCountElement = document.getElementById(`like-count-${postId}`);
                        if (likeCountElement) {
                            likeCountElement.innerText = likeCount;
                        }
                    }
                })
                .catch(error => console.error('Error updating like counts:', error));
        }

        // Poll every 2 seconds to update like counts
        setInterval(updateLikeCounts, 2000);


   
</script>




{% endblock content %}
