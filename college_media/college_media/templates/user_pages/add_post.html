{% extends "user_pages/base.html" %}
{% load static %}
{% block style %}

.right {
overflow: hidden;
}

.container-m {

overflow: hidden;
justify-content:center;
<!-- align-items:center; -->
column-gap:20px;
margin-top:5%;
display: flex;
flex-direction: row;
border: 2px solid rgb(42, 174, 188);
max-width:80%;
max-height:700px;
flex-wrap:wrap;
border-radius:20px;
gap:10px; <!--   New -->
box-sizing: border-box;
box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1), 0px 1px 8px rgba(0, 0, 0, 0.08);

}

.container-left {
display: flex;
flex-direction: column;
row-gap: 10px;
margin:0 10px 10px 10px;
align-items:center;
flex: 1;
max-height:100%;
max-width:50%;
font-family: 'Times New Roman', Times, serif;
color:gray;
padding-top: 20px; <!-- ===============New =====================-->
}
.container-left svg {
width: 100px;
height: 100px;
fill:rgb(42, 174, 188);
}
.img-in-container-left {
width: 100px;
height: 100px;
display:none;
}
.form-container{
display:flex;
flex-direction:column;
align-items:center;
row-gap:10px;
border-bottom:1px solid rgb(176, 174, 174);
<!-- flex-grow:1; -->
}
.form-container-descript{
box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
box-border:box-sizing;
border-radius:10px;
padding:10px;
<!-- margin:10px; -->
max-width:100%;
max-height:100%;
display:flex;
flex-direction:column;
font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
}
.form-container-descript textarea{
resize:none;
padding: 0px 5px;
font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
max-width:100%;
max-height:100%;
border: 1px solid rgba(86, 85, 90, 0.889);
border-radius:10px;

}
.buttons{
display:flex;
flex-direction:row;
flex-shrink:1;
<!-- flex-wrap:wrap; -->
justify-content:center;
<!-- width:100%;
height:100%; -->
}
.btnCancel, .btnSubmit{
cursor:pointer;
border:none;
border-radius:10px;
padding:10px;
background-color:rgb(79, 213, 228);
margin:10px;
color:white;
max-width:100px;
font-weight:bold;
font-size:medium;
font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
}
.btnCancel:hover, .btnSubmit:hover{
background-color:rgb(42, 174, 188);

}
#imageInput {
display:none;
}
.upload-button{
width:100%;
background-color:white;
border:none;
font-size:large;
color:rgb(11, 51, 153);
font-weight:300;
cursor:pointer;
font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
}


.container-m .container-right {
box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
max-width:50%;
color:gray;
width:300px;
height:460px;
min-height:100%;
flex:1;
margin:10px ;
padding:10px;
border-radius:10px;
display:none;

}
.img-in-container-left{
display:none;
}
.img-in-container-left img{
border-radius:10px;
width:100%;
height:100%;
}
.container-right img{
border-radius:10px;
width:80%;
height:54%;
display:flex;
margin:auto;

}
@media(max-width:600px){
.container-m{
margin-top:0;
padding:0px 25px;
overflow-y:auto;
}
.container-right{
display:none;
max-width:100%;
}
.container-left{
max-width:100%;
padding-top:0px;
}
.form-container-descript{
max-width:90%;
}
.upload-button {
font-size: medium;
}
}
.tags-specify{
display: flex;
position: relative;
flex-direction:column;
margin-top: 10px;
}
.tag-container {
display: flex;
position: relative;
flex-direction:column;
<!-- gap: 10px; -->
<!-- margin-top: 10px -->
}
.tag-options-list {
width: 100%;
border: 1px solid #ccc;
background-color: white;
border-radius: 4px;
max-height: 150px;
overflow-y: auto;
box-shadow: inset -3px -3px 20px rgba(42, 174, 188, 0.4);
}
.tag-options-list .tag{
padding:10px;
border-bottom:1px solid #ccc;
color:rgb(11 104 114);
}
.tag-options-list .tag:hover{
background-color:rgb(199 244 249 / 40%);

}
.container-m .child:nth-child(3) {
flex-direction: column; /* Align its content in a column */
}
.message {
margin: 10px;
position: absolute;
top: 0;
right: 0;
flex-grow: 1;
padding: 0 10px;
justify-content: center;
display: flex;
flex-direction: row;
align-items: center;
column-gap: 10px;
height: 50px;
color: rgb(252, 252, 252);
font-weight: bold;
max-width: 300px;
background-color: rgb(16, 108, 33);

border-radius: 10px;
}

.message-red {
margin: 10px;
position: absolute;
top: 0;
right: 0;
flex-grow: 1;
padding: 0 10px;
justify-content: center;
display: flex;
flex-direction: row;
align-items: center;
column-gap: 10px;
height: 50px;
color: rgb(252, 252, 252);
font-weight: bold;
max-width: 300px;
background-color: rgb(251, 39, 46);

border-radius: 10px;
}
.message-icon svg{
fill:white;
}
{% endblock style %}

{% block content %}
{% if messages %}
{% for message in messages %}
{% if 'post_sent' in message.tags %}
<div class="message">
    <div class="message-icon">
        <svg xmlns="http://www.w3.org/2000/svg" height="48px" viewBox="0 -960 960 960" width="48px" fill="#FFFFFF">
            <path
                d="m419-285 291-292-63-64-228 228-111-111-63 64 174 175Zm60.68 226q-86.32 0-163.65-32.6-77.32-32.61-134.57-89.86T91.6-316.03Q59-393.35 59-479.86q0-87.41 32.66-164.28Q124.33-721 181.7-778.58q57.38-57.57 134.41-90.49Q393.15-902 479.34-902q87.55 0 164.83 32.85 77.29 32.85 134.57 90.3 57.29 57.46 90.27 134.52Q902-567.26 902-479.46q0 86.74-32.93 163.55-32.92 76.81-90.49 134.2Q721-124.33 644.13-91.66 567.26-59 479.68-59Z" />
        </svg>
    </div>
    <div class="message-text">{{message}}</div>
</div>
{% elif 'tag_updated' in message.tags %}
<div class="message">
    <div class="message-icon"><svg xmlns="http://www.w3.org/2000/svg" height="30px" viewBox="0 -960 960 960"
            width="30px" fill="white">
            <path
                d="m419-285 291-292-63-64-228 228-111-111-63 64 174 175Zm60.68 226q-86.32 0-163.65-32.6-77.32-32.61-134.57-89.86T91.6-316.03Q59-393.35 59-479.86q0-87.41 32.66-164.28Q124.33-721 181.7-778.58q57.38-57.57 134.41-90.49Q393.15-902 479.34-902q87.55 0 164.83 32.85 77.29 32.85 134.57 90.3 57.29 57.46 90.27 134.52Q902-567.26 902-479.46q0 86.74-32.93 163.55-32.92 76.81-90.49 134.2Q721-124.33 644.13-91.66 567.26-59 479.68-59Z" />
        </svg></div>
    <div class="message-text">{{message}}</div>
</div>
{% endif %}
{% endfor %}
{% endif %}
<div class="right">
    <div class="container-m" id="add-post">
        <div class="container-left" id="image-display-for-drag">
            <h2>Add Post</h2>
            <div class="svg-image">
                <svg class="svg-element" xmlns="http://www.w3.org/2000/svg" height="48px" viewBox="0 -960 960 960"
                    width="48px" fill="#434343">
                    <path
                        d="M298.54-298.54h369.31L550.08-455.08q2.3 0 5.17.7 2.86.69 5.6 1.61L447-310.46l-71.46-86.77-77 98.69ZM215.38-160q-23.05 0-39.22-16.16Q160-192.33 160-215.38v-529.24q0-23.05 16.16-39.22Q192.33-800 215.38-800h181.47V-769.23H215.38q-9.23 0-16.92 7.69-7.69 7.69-7.69 16.92v529.24q0 9.23 7.69 16.92 7.69 7.69 16.92 7.69h529.24q9.23 0 16.92-7.69 7.69-7.69 7.69-16.92v-220.47L800-405.08v189.7q0 23.05-16.16 39.22Q767.67-160 744.62-160H215.38ZM480-480Zm377.31 11.08L727.37-598.85q-19.45 14.77-37.25 20.5-17.81 5.73-41.97 5.73-57.17 0-95.43-38.29-38.26-38.29-38.26-95.31 0-57.01 38.39-95.4Q591.23-840 647.77-840t94.92 38.32q38.39 38.32 38.39 95.37 0 24.16-7.23 45.69-7.23 21.54-21.23 41.77l126.92 126.93-22.23 23ZM647.77-603.38q44.08 0 73.31-29.62 29.23-29.62 29.23-73.69 0-44.08-29.11-73.31-29.11-29.23-73.82-29.23-43.69 0-72.92 29.11-29.23 29.1-29.23 73.81 0 43.69 29.23 73.31 29.23 29.62 73.31 29.62Z" />
                </svg>
                <div class="img-in-container-left" id="image-display">
                    <img src="" alt="image is displayed here" id="image">
                </div>
            </div>
            <div class="form-container">
                <form id="post-form" action='add_post' method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="file" id="imageInput" name="img" accept="image/*" onchange="displayImage(event)"
                        required>
                    <button type="button" class="upload-button"
                        onclick="document.getElementById('imageInput').click()">Drag and Drop image here</button>

            </div>
            <div class="form-container-descript">
                <label for="descript">Description</label>
                <textarea placeholder="maximum 50 words" id="descript" name="body" rows="8" cols="50"></textarea>

                <!-- <div class="buttons">
                    <button type="submit" class="btnSubmit">Submit Post</button>
                    <button type="reset" class="btnCancel" id="btnCancel" onclick="cancelPost()">Cancel</button>
                </div> -->
            </div>
            <div class="buttons">
                <input type="hidden" id="selected-tags-hidden" name="selected_tags" value="">
                <button type="submit" class="btnSubmit">Submit Post</button>
                <button type="reset" class="btnCancel" id="btnCancel" onclick="cancelPost()">Cancel</button>
            </div>
        </div>

        <div class="container-right" id="image-display-right">
            <img src="" alt="image is displayed here" id="image-right">

            <div class="tags-specify">
                <label for="tags">Select Tags</label>
                <div class="tag-container">
                    <input type="text" class="tag-input-value" id="tag-input" name="tag"
                        placeholder="Press & to see tags" />
                    <div class="tag-options-list" id="tag-options-list">
                        {% for tag in tags %}
                        <div class="tag" data-tag="{{tag.tag}}"> &{{tag.tag}}</div>
                        {% endfor %}



                        <!-- More tags can be added here -->
                    </div>
                </div>
                <!-- Notification area for tag input errors -->
                <div id="tag-notification" style="color:red; font-size:12px;"></div>

            </div>
        </div>


        <!-- <div class="buttons">
            <button type="submit" class="btnSubmit">Submit Post</button>
            <button type="reset" class="btnCancel" id="btnCancel" onclick="cancelPost()">Cancel</button>
        </div> -->
        </form>
    </div>
</div>
<script>
    function cancelPost() {
        document.getElementById('image-display').style.display = "none";
        document.querySelector('.svg-element').style.display = 'block';
    }
    function displayImage(event) {
        const imageLeft = document.getElementById("image");
        const imageRight = document.getElementById("image-right");
        const dropImageAreaLeft = document.getElementById("image-display");
        const dropImageAreaRight = document.getElementById("image-display-right");
        let file = null;

        if (event.target.files && event.target.files[0]) {
            file = event.target.files[0];
        } else if (event.dataTransfer && event.dataTransfer.files[0]) {
            file = event.dataTransfer.files[0];
        }

        if (file && file instanceof Blob) {
            const reader = new FileReader();
            reader.onload = function (e) {
                dropImageAreaLeft.style.display = "block";
                dropImageAreaRight.style.display = "block";
                imageLeft.src = e.target.result;
                imageRight.src = e.target.result;
            };
            reader.readAsDataURL(file);
            document.querySelector('.img-in-container-left').style.display = 'block';
            document.querySelector('.svg-element').style.display = 'none';
        } else {
            imageLeft.alt = "The file is not valid or no file selected.";
        }
    }


    // Drag and Drop handling
    const dropArea = document.getElementById("image-display-for-drag");

    dropArea.addEventListener("dragover", function (e) {
        e.preventDefault();  // Allow the drop
    });

    dropArea.addEventListener("drop", function (e) {
        e.preventDefault();  // Prevent default behavior (e.g., opening the file)
        const file = e.dataTransfer.files[0];  // Get the dropped file
        const inputFile = document.getElementById("imageInput");
        inputFile.files = e.dataTransfer.files;  // Simulate file selection
        displayImage(e);  // Show the image preview
    });

    const selectedTags = []; // Array to store selected tags
    const tagOptionsList = document.getElementById("tag-options-list");
    const tagInput = document.getElementById("tag-input");
    const hiddenTagsInput = document.getElementById("selected-tags-hidden");
    const maxTags = 3; // Maximum number of tags the user can select
    function updateHiddenTagsInput() {
        hiddenTagsInput.value = selectedTags.join(',');
        console.log(hiddenTagsInput)
    }
    // Hide the tag list initially
    tagOptionsList.style.display = 'none';

    // Function to check if the input is a valid tag
    function validateTagInput() {
        const inputTags = tagInput.value.split(',').map(tag => tag.trim().toLowerCase());
        const tags = tagOptionsList.querySelectorAll('.tag');
        const tagNotification = document.getElementById("tag-notification");

        // Check if each tag is in the list
        const invalidTags = inputTags.filter(tag => {
            return tag && !Array.from(tags).some(tagOption => tagOption.textContent.trim().toLowerCase() === tag);
        });

        // If there are invalid tags, show notification
        if (invalidTags.length > 0) {
            if (!tagNotification) {
                const notification = document.createElement('div');
                notification.id = "tag-notification";
                notification.style.color = 'red';
                notification.style.fontSize = '12px';
                notification.textContent = `Tag(s) not found: ${invalidTags.join(', ')}`;
                tagInput.parentNode.appendChild(notification);
            }
        } else {
            if (tagNotification) {
                tagNotification.remove(); // Remove notification if all tags are valid
            }
        }
    }

    // Event listener to handle input and filter tags
    tagInput.addEventListener("input", function () {
        const searchTerm = tagInput.value.toLowerCase().trim();
        const tags = tagOptionsList.querySelectorAll('.tag');

        // Create an array to store matched tags
        const matchedTags = [];
        const otherTags = [];

        // Loop through tags and classify them as matched or others
        tags.forEach(tag => {
            const tagText = tag.textContent.trim().toLowerCase();
            if (tagText.includes(searchTerm) && selectedTags.indexOf(tag.dataset.tag) === -1) {
                matchedTags.push(tag); // Store matched tags
            } else {
                otherTags.push(tag); // Store other tags
            }
        });

        // Clear the list and append matched tags at the top
        tagOptionsList.innerHTML = '';
        matchedTags.forEach(tag => tagOptionsList.appendChild(tag));
        otherTags.forEach(tag => tagOptionsList.appendChild(tag));

        // Show the tag list
        if (matchedTags.length > 0 || otherTags.length > 0) {
            tagOptionsList.style.display = 'block';
        } else {
            tagOptionsList.style.display = 'none'; // Hide the list if no matching tags
        }

        // Validate the input after each typing
        validateTagInput();
    });

    // Event listener for tag selection/deselection
    tagOptionsList.addEventListener("click", function (event) {
        const clickedTag = event.target;
        const tagName = clickedTag.dataset.tag;

        // Check if the tag is already selected
        const tagIndex = selectedTags.indexOf(tagName);

        if (tagIndex === -1 && selectedTags.length < maxTags) {
            // If not selected, select it
            selectedTags.push(tagName);
            clickedTag.style.backgroundColor = "#ccc"; // Mark the tag as selected visually
        } else if (tagIndex !== -1) {
            // If already selected, deselect it
            selectedTags.splice(tagIndex, 1);
            clickedTag.style.backgroundColor = ""; // Reset background color
        }

        // Update the input field to show selected tags
        tagInput.value = selectedTags.join(', '); // Join tags with comma

        console.log("Selected tags: ", selectedTags); // Log selected tags

        // Validate the input again when a tag is selected
        validateTagInput();
    });

    // Prevent adding more than three tags
    tagInput.addEventListener('blur', function () {
        if (selectedTags.length > maxTags) {
            alert("You can only select up to 3 tags.");
            selectedTags.splice(maxTags); // Limit to the first 3 tags
            tagInput.value = selectedTags.join(', '); // Update the input field with limited tags
        }

        // Validate the input when the field loses focus
        validateTagInput();
    });

    // Handle browser autocomplete
    tagInput.addEventListener('change', function () {
        // Validate input when autocomplete changes the input value
        validateTagInput();
    });

    // Function to clear selected tags (optional, for the cancel button or other use cases)
    function cancelPost() {
        selectedTags.length = 0; // Clear selected tags array
        const tags = document.querySelectorAll('.tag');
        tags.forEach(tag => {
            tag.style.backgroundColor = ""; // Reset background color
        });
        tagInput.value = ''; // Clear input field
        const tagNotification = document.getElementById("tag-notification");
        if (tagNotification) {
            tagNotification.remove(); // Remove notification if canceled
        }
        document.getElementById('image-display').style.display = "none";
        document.querySelector('.svg-element').style.display = 'block';
        document.getElementById("image-display-right").style.display = "none";
    }

    // Function to handle clearing the input and deselecting all tags
    tagInput.addEventListener('input', function () {
        const inputTags = tagInput.value.split(',').map(tag => tag.trim());

        // Deselect tags that were removed from the input field
        const tagsToDeselect = selectedTags.filter(tag => !inputTags.includes(tag));

        // Deselect each tag that is no longer in the input
        tagsToDeselect.forEach(tag => {
            const tagElement = tagOptionsList.querySelector(`[data-tag="${tag}"]`);
            if (tagElement) {
                tagElement.style.backgroundColor = ''; // Reset background color
            }
            const index = selectedTags.indexOf(tag);
            if (index !== -1) {
                selectedTags.splice(index, 1); // Remove the tag from the selectedTags array
            }
        });

        // Validate input
        validateTagInput();
    });

    tagOptionsList.addEventListener("click", (e) => {
        const tagElement = e.target;
        if (tagElement.classList.contains("tag")) {
            const tagValue = tagElement.dataset.tag;

            if (!selectedTags.includes(tagValue)) {
                if (selectedTags.length < maxTags) {
                    selectedTags.push(tagValue);
                    tagInput.value = selectedTags.join(", "); // Display selected tags
                    updateHiddenTagsInput(); // Update hidden input
                } else {
                    tagNotification.textContent = `You can select up to ${maxTags} tags.`;
                }
            }
        }
    });
    document.getElementById("post-form").addEventListener("submit", function (event) {
        // Update the hidden input field with the selected tags before submission
        const hiddenTagsInput = document.getElementById("selected-tags-hidden");
        hiddenTagsInput.value = selectedTags.join(','); // Join selected tags with a comma
        console.log("Form submitted with tags:", hiddenTagsInput.value);
    });


</script>
{% endblock content %}